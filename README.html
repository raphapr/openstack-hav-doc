<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
</head>
<body>
<h3 id="tutorial-de-instalação-do-openstack-havana">Tutorial de Instalação do OpenStack Havana</h3>
<p><strong>Autor:</strong></p>
<p>Copyright (C) Raphael Pereira Ribeiro</p>
<p>A idéia deste tutorial é proporcionar um caminho simplificado para implementação de uma estrutura de computação em nuvem utilizando OpenStack, preocupando-se mais com aspectos técnicos do que conceitos gerais.</p>
<p>Trabalharemos em ambiente Linux, mais especificamente teremos como base o Debian 7.0 Linux e OpenStack versão Havana.</p>
<p>Utilizaremos duas máquinas ( do cluster ) modelo RU, cada máquina conta com: - 2 processadores Intel(R) Xeon(R) CPU X5570 - 24GB de memória RAM - 128GB de disco (armazenamento HDD) - 2 interface infiniband ( rede de interconexão de alto desempenho ) - 4 interfaces Gigabit Ethernet</p>
<p>As máquinas estão ligadas por três redes: - Uma rede llom ( rede de gerência através da qual obtemos acesso remoto as máquinas ) - Duas redes Gigabit Ethernet São Necessárias apenas duas interconexões de rede Gigabit Ethernet.</p>
<p>A partir de agora chamaremos as duas máquinas respectivamente de controller e compute. - nó controller -&gt; máquina que hospedará os serviços de gerência ( Keystone, Glance, Nova e Horizon ) - nó compute -&gt; máquina que hospedará as máquinas virtuais O serviço Nova é hospedado em ambas as máquinas.</p>
<p>O processo de implementação, neste tutorial, segue basicamente 6 tópicos:</p>
<ol style="list-style-type: decimal">
<li>Configurações Básicas do Sistema Operacional</li>
<li>Serviço de Identificação ( Keystone )</li>
<li>Serviço de gerência de Imagens ( Glance )</li>
<li>Serviço de Computação ( Nova )</li>
<li>Serviço de Orquestração ( Heat )</li>
<li>Painel de Controle ( Horizon )</li>
</ol>
<h3 id="configurações-básicas-do-sistema-operacional">1. Configurações Básicas do Sistema Operacional</h3>
<p>A arquitetura de rede dos dois nós será da seguinte forma:</p>
<p><img src="https://raw.githubusercontent.com/raphapr/openstack-havana-installation/master/img/arch.png" title="Topologia" alt="alt text" /> <URL DA IMAGEM></p>
<p><strong>Exemplo 1 (controller) /etc/network/interfaces:</strong></p>
<pre><code># Internal Network
auto eth0
iface eth0 inet static
address 192.168.0.10
netmask 255.255.255.0
# External Network
auto eth1
iface eth1 inet static
address 10.0.0.10
netmask 255.255.255.0
</code></pre>
<p>Configurar da mesma maneira para o compute node, apenas mudando o endereço para 10.0.0.11 e 192.168.0.11</p>
<p>Depois, restarte o serviço de rede:</p>
<pre><code># service networking restart</code></pre>
<p>É importante também mudar o hostname de cada máquina. O nome do controller node de controller e o primeiro compute node de compute1.</p>
<pre><code># hostname controller</code></pre>
<p>(Fazer o mesmo pra o compute node)</p>
<p>Edite o seguinte arquivo para que a mudança permaneça após o reboot:</p>
<p><strong>Exemplo 2: /etc/hostname</strong></p>
<pre><code>controller</code></pre>
<p>(Fazer o mesmo pra o compute node)</p>
<p>Por último, para garantir que cada nó alcance o outro através do hostname, é necessário editar o arquivo /etc/hosts para cada sistema:</p>
<p><strong>Exemplo 3: /etc/hosts</strong></p>
<pre><code>127.0.0.1       localhost
192.168.0.10    controller
192.168.0.11    compute1</code></pre>
<h4 id="ntp">1.2. NTP</h4>
<p>Para sincronizar os serviços do OpenStack em múltiplas máquinas, você precisa installar o NTP:</p>
<pre><code># apt-get install ntp</code></pre>
<p>Configure os seguintes servidores NTP no /etc/ntp.conf:</p>
<pre><code>server 0.br.pool.ntp.org
server 3.south-america.pool.ntp.org
server 2.south-america.pool.ntp.org</code></pre>
<ul>
<li><strong>Problema encontrado</strong></li>
</ul>
<p>O problema se deu pois não estava sendo possível sincronizar o controller e o compute1, a solução foi que o controller estava em uma timezone diferente, o que não foi percebido inicialmente.</p>
<ul>
<li><strong>Solução</strong></li>
</ul>
<p>Mudar a timezone no Debian Wheezy:</p>
<pre><code># mv /etc/localtime /etc/localtime.old
# cp /usr/share/zoneinfo/America/Maceio /etc/localtime</code></pre>
<h4 id="mysql">1.3. MySQL</h4>
<p><strong>Controller Node</strong></p>
<pre><code># apt-get install python-mysqldb mysql-server</code></pre>
<p>Edite o /etc/mysql/my.cnf pra configurar o bind-address para o endereço de IP interno do controller:</p>
<pre><code>[mysqld]
...
bind-address = 192.168.0.10</code></pre>
<p>Reinicie o serviço MySQL:</p>
<pre><code># service mysql restart</code></pre>
<p><strong>Compute Node</strong></p>
<pre><code># apt-get install python-mysqldb</code></pre>
<ul>
<li><strong>Problema encontrado</strong></li>
</ul>
<p>Após instalar o MySQL no controller, na tentativa de mudar a senha root pelo comando “mysql -u root -p” acusava o seguinte erro: mySQL ERROR 1045 (28000): Access denied for user 'root'@'localhost.</p>
<ul>
<li><strong>Solução</strong></li>
</ul>
<p>http://dev.mysql.com/doc/refman/5.0/en/resetting-permissions.html#resetting-permissions-windows</p>
<h3 id="pacotes-openstack">1.4. Pacotes OpenStack</h3>
<p>Installe o RabbitMQ apenas no controller node:</p>
<pre><code># apt-get install rabbitmq-server</code></pre>
<p>O rabbitmq-server configura o RabbitMQ para startar automaticamente com o usuário guest, que utilizaremos nesse tutorial, com uma senha padrão, recomendável mudar essa senha:</p>
<pre><code># rabbitmqctl change_password guest RABBIT_PASS</code></pre>
<h3 id="python-argparse">1.5 Python-argparse</h3>
<p>Instalar em ambos os nós:</p>
<pre><code># apt-get install python-argparse</code></pre>
<h2 id="configurando-o-identity-service">2. Configurando o identity service</h2>
<ul>
<li>Não houve nenhum problema encontrado na instalação deste serviço.</li>
</ul>
<p>Instale o OpenStack Identity Service</p>
<pre><code># apt-get install keystone</code></pre>
<p>Edite /etc/keystone/keystone.conf e mude a seção [sql].</p>
<pre><code>...
[sql]
# The SQLAlchemy connection string used to connect to the database
connection = mysql://keystone:KEYSTONE_DBPASS@controller/keystone
…</code></pre>
<p>Crie um banco de dados para o serviço keystone.</p>
<pre><code># mysql -u root -p
mysql&gt; CREATE DATABASE keystone;
mysql&gt; GRANT ALL PRIVILEGES ON keystone.* TO &#39;keystone&#39;@&#39;localhost&#39; \
IDENTIFIED BY &#39;KEYSTONE_DBPASS&#39;;
mysql&gt; GRANT ALL PRIVILEGES ON keystone.* TO &#39;keystone&#39;@&#39;%&#39; \
IDENTIFIED BY &#39;KEYSTONE_DBPASS&#39;;</code></pre>
<p>Crie as tabelas de banco de dados:</p>
<pre><code># keystone-manage db_sync</code></pre>
<p>Gere um token de autorização para que o Keystone possa se comunicar com os outros serviços do OpenStack.</p>
<pre><code># openssl rand -hex 10</code></pre>
<p>Edite /etc/keystone/keystone.conf e mude a seção [DEFAULT], substituindo ADMIN_TOKEN pelo resultado do comando.</p>
<pre><code>[DEFAULT]
# A &quot;shared secret&quot; between keystone and other openstack services
admin_token = ADMIN_TOKEN
…</code></pre>
<p>Reinicie o serviço</p>
<pre><code># service keystone restart</code></pre>
<h3 id="definindo-users-tenants-and-roles">2.2 Definindo users, tenants, and roles</h3>
<p>Para ter autorização ao Keystone, você precisa se autenticar à ele da seguinte forma:</p>
<pre><code># export OS_SERVICE_TOKEN=ADMIN_TOKEN
# export OS_SERVICE_ENDPOINT=http://controller:35357/v2.0</code></pre>
<p>Onde ADMIN_TOKEN é o TOKEN de autorização criado na seção 2.1</p>
<p>Crie um tenant para o usuário admin e outro para outros serviços OpenStack.</p>
<pre><code># keystone tenant-create --name=admin --description=&quot;Admin Tenant&quot;
# keystone tenant-create --name=service --description=&quot;Service Tenant&quot;</code></pre>
<p>Logo após, crie um usuário admin.</p>
<pre><code># keystone user-create --name=admin --pass=ADMIN_PASS \
   --email=admin@example.com</code></pre>
<p>Crie um role para tarefas administrativas.</p>
<pre><code># keystone role-create --name=admin</code></pre>
<p>Atribua o role e tenant ao usuário.</p>
<pre><code># keystone user-role-add --user=admin --tenant=admin --role=admin</code></pre>
<h3 id="definindo-serviços-e-api-endpoints">2.3 Definindo serviços e API endpoints</h3>
<p>Para que o Identity Service possa rastrear outros serviços OpenStack instalados e localizá-los na rede, vocẽ precisa registrar cada serviço no Keystone. Pra registrar um serviço, rode os seguintes comandos:</p>
<p>Crie uma entrada do serviço.</p>
<pre><code># keystone service-create --name=keystone --type=identity \
  --description=&quot;Keystone Identity Service&quot;
+-------------+----------------------------------+
|   Property  |              Value               |
+-------------+----------------------------------+
| description | Keystone Identity Service        |
| id          | 15c11a23667e427e91bc31335b45f4bd |
| name        | keystone                         |
| type        | identity                         |
+-------------+----------------------------------+</code></pre>
<p>Especifique um API endpoint para o identity Service usando a ID de retorno do comando anterior.</p>
<pre><code># keystone endpoint-create \
  --service-id=the_service_id_above \
  --publicurl=http://controller:5000/v2.0 \
  --internalurl=http://controller:5000/v2.0 \
  --adminurl=http://controller:35357/v2.0
+-------------+-----------------------------------+
|   Property  |             Value                 |
+-------------+-----------------------------------+
| adminurl    | http://controller:35357/v2.0      |
| id          | 11f9c625a3b94a3f8e66bf4e5de2679f  |
| internalurl | http://controller:5000/v2.0       |
| publicurl   | http://controller:5000/v2.0       |
| region      | regionOne                         |
| service_id  | 15c11a23667e427e91bc31335b45f4bd  |
+-------------+-----------------------------------+</code></pre>
<p>Ao longo da instalação dos serviços OpenStack, você precisará registrar os serviços no Identify Service (Keystone).</p>
<h3 id="verificando-a-instalação-do-identify-service">2.4 Verificando a instalação do Identify Service</h3>
<p>É importante criar um arquivo local com as credenciais do Keystone e carregar suas informações nas variáveis do ambiente:</p>
<p>Crie um arquivo ~/.keystonerc:</p>
<pre><code>export OS_USERNAME=admin
export OS_PASSWORD=ADMIN_PASS
export OS_TENANT_NAME=admin
export OS_AUTH_URL=http://controller:35357/v2.0</code></pre>
<p>Carregue-o:</p>
<pre><code># source ~./.keystonerc
# echo “ source  ~/.keystonerc” &gt;&gt; ~/.bash_profile</code></pre>
<p>Finalmente, para verificar se o Keystone está funcionando juntamente com suas credenciais, insira o comando abaixo.</p>
<pre><code># keystone user-list
+----------------------------------+---------+--------------------+--------+
|                id                | enabled | email              |  name  |
+----------------------------------+---------+--------------------+--------+
| a4c2d43f80a549a19864c89d759bb3fe | True    | admin@example.com  | admin  |</code></pre>
<h2 id="instalando-o-image-service-glance">3. Instalando o Image Service (Glance)</h2>
<ul>
<li>Não houve nenhum problema encontrado na instalação deste serviço.</li>
</ul>
<p>Instale o Image Service no controller node.</p>
<pre><code># apt-get install glance python-glanceclient</code></pre>
<p>Edite /etc/glance/glance-api.conf e /etc/glance/glance-registry.conf e mude a seção [DEFAULT]</p>
<pre><code>...
[DEFAULT]
...
# SQLAlchemy connection string for the reference implementation
# registry server. Any valid SQLAlchemy connection string is fine.
# See: http://www.sqlalchemy.org/docs/05/reference/sqlalchemy/connections.html#sqlalchemy.create_engine
sql_connection = mysql://glance:GLANCE_DBPASS@controller/glance
…</code></pre>
<p>Crie um usuário glance no banco de dados MySQL.</p>
<pre><code># mysql -u root -p
mysql&gt; CREATE DATABASE glance;
mysql&gt; GRANT ALL PRIVILEGES ON glance.* TO &#39;glance&#39;@&#39;localhost&#39; \
IDENTIFIED BY &#39;GLANCE_DBPASS&#39;;
mysql&gt; GRANT ALL PRIVILEGES ON glance.* TO &#39;glance&#39;@&#39;%&#39; \
IDENTIFIED BY &#39;GLANCE_DBPASS&#39;;</code></pre>
<p>Gere as tabelas de banco de dados do Glance.</p>
<pre><code># glance-manage db_sync</code></pre>
<p>Crie um usuário e role glance no Identity Service para que possa se autenticar com o Keystone.</p>
<pre><code># keystone user-create --name=glance --pass=GLANCE_PASS \
   --email=glance@example.com
# keystone user-role-add --user=glance --tenant=service --role=admin</code></pre>
<p>Configure o Image Service para usar o Identity Service para autenticação. Edite os arquivos /etc/glance/glance-api.conf e /etc/glance/glance-registry.conf:</p>
<pre><code>[keystone_authtoken]
...
auth_uri = http://controller:5000
auth_host = controller
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = glance
admin_password = GLANCE_PASS</code></pre>
<p>Adicione a linha seguinte na seção [paste_deploy].</p>
<pre><code>[paste_deploy]
...
flavor = keystone</code></pre>
<p>Adicione as credenciais nos arquivos /etc/glance/glance-api-paste.ini e /etc/glance/glance-registry-paste.ini. Edite cada arquivo com as seguintes opções na seção [filter:authtoken] e deixe todas as outras opções existentes.</p>
<pre><code>[filter:authtoken]
paste.filter_factory=keystoneclient.middleware.auth_token:filter_factory
auth_host=controller
admin_user=glance
admin_tenant_name=service
admin_password=GLANCE_PASS</code></pre>
<p>Registre o Image Service no keystone.</p>
<pre><code># keystone service-create --name=glance --type=image \
  --description=&quot;Glance Image Service&quot;</code></pre>
<p>Use o ID retornado com o comando acima para criar um endpoint.</p>
<pre><code># keystone endpoint-create \
  --service-id=the_service_id_above \
  --publicurl=http://controller:9292 \
  --internalurl=http://controller:9292 \
  --adminurl=http://controller:9292</code></pre>
<p>Reinicie o glance</p>
<pre><code># service glance-registry restart
# service glance-api restart</code></pre>
<h3 id="verificando-a-instalação-do-image-service-glance">3.2 Verificando a instalação do Image Service (Glance)</h3>
<p>Baixe uma imagem para testes (cirrOS) usando wget.</p>
<pre><code># mkdir images
# cd images/
# wget http://download.cirros-cloud.net/0.3.1/cirros-0.3.1-x86_64-disk.img</code></pre>
<ul>
<li>Repositório: http://download.cirros-cloud.net/</li>
</ul>
<p>Faça o upload dessa imagem através do Image Service.</p>
<pre><code># glance image-create --name=&quot;CirrOS 0.3.1&quot; --disk-format=qcow2 \
  --container-format=bare --is-public=true &lt; cirros-0.3.1-x86_64-disk.img
+------------------+--------------------------------------+
| Property         | Value                                |
+------------------+--------------------------------------+
| checksum         | d972013792949d0d3ba628fbe8685bce     |
| container_format | bare                                 |
| created_at       | 2013-10-08T18:59:18                  |
| deleted          | False                                |
| deleted_at       | None                                 |
| disk_format      | qcow2                                |
| id               | acafc7c0-40aa-4026-9673-b879898e1fc2 |
| is_public        | True                                 |
| min_disk         | 0                                    |
| min_ram          | 0                                    |
| name             | CirrOS 0.3.1                         |
| owner            | efa984b0a914450e9a47788ad330699d     |
| protected        | False                                |
| size             | 13147648                             |
| status           | active                               |
| updated_at       | 2013-05-08T18:59:18                  |
+------------------+--------------------------------------+</code></pre>
<p>Confirme o upload da imagem mostrando seus atributos através do comando:</p>
<pre><code># glance image-list
+--------------------------------------+-----------------+-------------+------------------+----------+--------+
| ID                                   | Name            | Disk Format | Container Format | Size     | Status |
+--------------------------------------+-----------------+-------------+------------------+----------+--------+
| acafc7c0-40aa-4026-9673-b879898e1fc2 | CirrOS 0.3.1    | qcow2       | bare             | 13147648 | active |
+--------------------------------------+-----------------+-------------+------------------+----------+--------+
</code></pre>
<h2 id="configurando-os-serviços-compute-nova">4. Configurando os serviços compute (Nova)</h2>
<h3 id="instalando-os-serviços-compute-no-controller-node">4.2. Instalando os serviços compute no controller node</h3>
<ul>
<li>Não houve nenhum problema encontrado na instalação deste serviço.</li>
</ul>
<p>Instale esses pacotes OpenStack, que fornece os serviços compute no controller.</p>
<pre><code># apt-get install nova-consoleproxy nova-api \
  nova-cert nova-conductor nova-consoleauth \
  nova-scheduler python-novaclient</code></pre>
<p>Configure a localização do banco de dados, rabbitMQ e rede editando o arquivo /etc/nova/nova.conf e deixando semelhante ao arquivo do link abaixo:</p>
<ul>
<li>http://pastebin.com/THRr4eCR</li>
</ul>
<p>Lembrando de alterar NOVA_DBPASS, NOVA_PASS e RABBIT_PASS.</p>
<p>Crie um usuário nova no banco de dados MySQL com a senha NOVA_DBPASS definida no arquivo /etc/nova/nova.conf.</p>
<pre><code># mysql -u root -p
mysql&gt; CREATE DATABASE nova;
mysql&gt; GRANT ALL PRIVILEGES ON nova.* TO &#39;nova&#39;@&#39;localhost&#39; \
IDENTIFIED BY &#39;NOVA_DBPASS&#39;;
mysql&gt; GRANT ALL PRIVILEGES ON nova.* TO &#39;nova&#39;@&#39;%&#39; \
IDENTIFIED BY &#39;NOVA_DBPASS&#39;;</code></pre>
<p>Crie as tabelas do Compute Service.</p>
<pre><code># nova-manage db sync</code></pre>
<p>Crie um usuário e role do Nova no Keystone.</p>
<pre><code># keystone user-create --name=nova --pass=NOVA_PASS --email=nova@example.com
# keystone user-role-add --user=nova --tenant=service --role=admin</code></pre>
<p>Adicione as credentiais no arquivo /etc/nova/api-paste.ini, na seção [filter:authtoken]:</p>
<pre><code>[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
auth_host = controller
auth_port = 35357
auth_protocol = http
auth_uri = http://controller:5000/v2.0
admin_tenant_name = service
admin_user = nova
admin_password = NOVA_PASS</code></pre>
<p>Agora você precisa registrar o serviço Nova no Keystone.</p>
<pre><code># keystone service-create --name=nova --type=compute \
  --description=&quot;Nova Compute service&quot;</code></pre>
<p>Use o ID retornado pelo comando acima para criar um endpoint no Keystone.</p>
<pre><code># keystone endpoint-create \
  --service-id=the_service_id_above \
  --publicurl=http://controller:8774/v2/%\(tenant_id\)s \
  --internalurl=http://controller:8774/v2/%\(tenant_id\)s \
  --adminurl=http://controller:8774/v2/%\(tenant_id\)s</code></pre>
<p>Reinicie os serviços do Nova.</p>
<pre><code># service nova-api restart
# service nova-cert restart
# service nova-consoleauth restart
# service nova-scheduler restart
# service nova-conductor restart
# service nova-novncproxy restart</code></pre>
<p>Verifique a configuração, listando as imagens disponíveis</p>
<pre><code># nova image-list
+--------------------------------------+-----------------+--------+--------+
| ID                                   | Name            | Status | Server |
+--------------------------------------+-----------------+--------+--------+
| acafc7c0-40aa-4026-9673-b879898e1fc2 | CirrOS 0.3.1    | ACTIVE |        |
+--------------------------------------+-----------------+--------+--------+</code></pre>
<h3 id="instalando-os-serviços-compute-no-compute-node">4.3. Instalando os serviços compute no compute node</h3>
<p>Certifique-se de ter feito todos os passos da seção “1. Configurações Básicas do Sistema Operacional” no compute node.</p>
<p>Depois de ter configurado seu sistema, rode o seguinte comando para instalar os pacotes apropriados:</p>
<pre><code># apt-get install nova-compute-kvm python-guestfs nova-network nova-api-metadata</code></pre>
<ul>
<li>Problemas encontrados</li>
</ul>
<p>Houve muita dificuldade por causa da documentação oficial mal escrita, o problema é que o principal arquivo de configuração do nova, /etc/nova/nova.conf, possui algumas linhas não comentadas que podem atrapalhar na hora da configuração, então o ideal seria comentar todas elas, você deve adicionar as seguintes linhas tendo que ser alterado como se deve as principais flags: DB_PASS, RABBIT_PASS</p>
<pre><code>[DEFAULT]
### DATABASE
connection = mysql://nova:NOVA_DBPASS@controller/nova
### APIs
enabled_apis=ec2,osapi_compute,metadata
api_paste_config=api-paste.ini
### SYSTEM
state_path=/var/lib/nova
lock_path=/var/lock/nova
rootwrap_config=/etc/nova/rootwrap.conf
### AUTHENTICATION
auth_strategy=keystone
### RABBITMQ
rpc_backend = nova.rpc.impl_kombu
rabbit_host = controller
rabbit_password = RABBIT_PASS
rabbit_virtual_host=/
### GLANCE
glance_host=controller
### Type of network APIs to use
network_api_class=nova.network.api.API
security_group_api = nova
### NETWORK (linux net)
dhcpbridge_flagfile=/etc/nova/nova.conf
dhcpbridge=/usr/bin/nova-dhcpbridge
network_manager=nova.network.manager.FlatDHCPManager
firewall_driver=nova.virt.libvirt.firewall.IptablesFirewallDriver
network_size=254
allow_same_net_traffic=False
send_arp_for_ha=True
flat_network_bridge=br100
flat_interface=eth1
public_interface=eth1
### NOVNC CONSOLE
vnc_enabled=True
vncserver_listen=0.0.0.0
vncserver_proxyclient_address=192.168.0.11
novncproxy_base_url=http://controller:6080/vnc_auto.html</code></pre>
<p>No nova-compute.conf, editar a flag libvirt_vif_driver para libvirt_vif_driver=nova.virt.libvirt.vif.LibvirtGenericVIFDriver</p>
<p>Edite o arquivo /etc/nova/api-paste.ini e adicione as credenciais na seção [filter:authtoken]:</p>
<pre><code>[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
auth_host = controller
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = nova
admin_password = NOVA_PASS</code></pre>
<p>Reinicie o compute service e o nova-network.</p>
<pre><code># service nova-compute restart
# service nova-network restart</code></pre>
<p><strong>AVISO:</strong> A partir daqui, em se tratando da rede do OpenStack muitos problemas inesperados podem surgir, sempre olhar os logs /var/log/nova/</p>
<p>Crie a rede das máquinas virtuais.</p>
<pre><code># nova network-create vmnet --fixed-range-v4=10.0.0.0/24 \
  --bridge=br100 --multi-host=T</code></pre>
<h3 id="lançando-uma-instância">4.4 Lançando uma instância</h3>
<p>Você deverá criar um par de chaves (pública/privada) para estar apto a lançar instâncias no OpenStack e acessá-las via SSH.</p>
<pre><code>$ ssh-keygen
$ cd .ssh
$ nova keypair-add --pub_key id_rsa.pub mykey</code></pre>
<p>Cerfique-se de que você adicionou as chaves no Nova.</p>
<pre><code>$ nova keypair-list
+--------+-------------------------------------------------+
|  Name  |                   Fingerprint                   |
+--------+-------------------------------------------------+
| mykey  | b0:18:32:fa:4e:d4:3c:1b:c4:6c:dd:cb:53:29:13:82 |
+--------+-------------------------------------------------+</code></pre>
<p>Escolha um flavor.</p>
<pre><code>$ nova flavor-list</code></pre>
<p>Pegue o ID da imagem que você usará na instância.</p>
<pre><code>$ nova image-list
+--------------------------------------+--------------+--------+--------+
| ID                                   | Name         | Status | Server |
+--------------------------------------+--------------+--------+--------+
| 9e5c2bee-0373-414c-b4af-b91b0246ad3b | CirrOS 0.3.1 | ACTIVE |        |
+--------------------------------------+--------------+--------+--------+</code></pre>
<p>Para poder usar ping e ssh, você deve configurar as regras do seu security group.</p>
<pre><code># nova secgroup-add-rule default tcp 22 22 0.0.0.0/0
# nova secgroup-add-rule default icmp -1 -1 0.0.0.0/0</code></pre>
<p>Lance a instância:</p>
<pre><code>$ nova boot --flavor flavorType --key_name keypairName --image ID newInstanceName</code></pre>
<p><strong>Exemplo:</strong></p>
<pre><code>$ nova boot --flavor 1 --key_name mykey --image 9e5c2bee-0373-414c-b4af-b91b0246ad3b --security_group default cirrOS
+--------------------------------------+--------------------------------------+
| Property                             | Value                                |
+--------------------------------------+--------------------------------------+
| OS-EXT-STS:task_state                | scheduling                           |
| image                                | CirrOS 0.3.1                         |
| OS-EXT-STS:vm_state                  | building                             |
| OS-EXT-SRV-ATTR:instance_name        | instance-00000001                    |
| OS-SRV-USG:launched_at               | None                                 |
| flavor                               | m1.tiny                              |
| id                                   | 3bdf98a0-c767-4247-bf41-2d147e4aa043 |
| security_groups                      | [{u&#39;name&#39;: u&#39;default&#39;}]              |
| user_id                              | 530166901fa24d1face95cda82cfae56     |
| OS-DCF:diskConfig                    | MANUAL                               |
| accessIPv4                           |                                      |
| accessIPv6                           |                                      |
| progress                             | 0                                    |
| OS-EXT-STS:power_state               | 0                                    |
| OS-EXT-AZ:availability_zone          | nova                                 |
| config_drive                         |                                      |
| status                               | BUILD                                |
| updated                              | 2013-10-10T06:47:26Z                 |
| hostId                               |                                      |
| OS-EXT-SRV-ATTR:host                 | None                                 |
| OS-SRV-USG:terminated_at             | None                                 |
| key_name                             | mykey                                |
| OS-EXT-SRV-ATTR:hypervisor_hostname  | None                                 |
| name                                 | cirrOS                               |
| adminPass                            | DWCDW6FnsKNq                         |
| tenant_id                            | e66d97ac1b704897853412fc8450f7b9     |
| created                              | 2013-10-10T06:47:23Z                 |
| os-extended-volumes:volumes_attached | []                                   |
| metadata                             | {}                                   |
+--------------------------------------+--------------------------------------+</code></pre>
<p>Depois de lançar a instância, use nova list para ver seu status.</p>
<pre><code>$ nova list</code></pre>
<h2 id="instalando-o-serviço-de-orquestração-heat">5. Instalando o serviço de Orquestração Heat</h2>
<ul>
<li>Não houve nenhum problema encontrado na instalação deste serviço.</li>
</ul>
<p>Instale o módulo de orquestração Heat no controller node:</p>
<pre><code># apt-get install heat-api heat-api-cfn heat-engine
</code></pre>
<p>No arquivo de configuração, especifique a localização do banco de dados onde o heat irá armazenar os dados:</p>
<p>Edite /etc/heat/heat.conf e mude a seção [DEFAULT]</p>
<pre><code>[DEFAULT]
# The SQLAlchemy connection string used to connect to the database
sql_connection = mysql://heat:HEAT_DBPASS@controller/heat
...</code></pre>
<p>Crie o banco de dados para o serviço heat:</p>
<pre><code># mysql -u root -p
mysql&gt; CREATE DATABASE heat;
mysql&gt; GRANT ALL PRIVILEGES ON heat.* TO &#39;heat&#39;@&#39;localhost&#39; \
IDENTIFIED BY &#39;HEAT_DBPASS&#39;;
mysql&gt; GRANT ALL PRIVILEGES ON heat.* TO &#39;heat&#39;@&#39;%&#39; \
IDENTIFIED BY &#39;HEAT_DBPASS&#39;;</code></pre>
<p>Crie as tabelas do serviço heat:</p>
<pre><code># heat-manage db_sync</code></pre>
<h3 id="verificando-a-instalação-do-heat">5.2 Verificando a instalação do heat</h3>
<h4 id="crie-um-stack-com-um-arquivo-template">5.2.1 Crie um stack com um arquivo template</h4>
<p>Pra criar um stack, baixe um <a href="https://github.com/openstack/heat-templates">template exemplo</a> e rode o seguinte comando:</p>
<pre><code>heat stack-create mystack --template-file=/PATH_TO_HEAT_TEMPLATES/WordPress_Single_Instance.template
     --parameters=&quot;InstanceType=m1.large;DBUsername=USERNAME;DBPassword=PASSWORD;KeyName=HEAT_KEY;LinuxDistribution=F17&quot;</code></pre>
<p>Os valores <em>--parameters</em> que você especifica depende dos definidos no template.</p>
<p>O comando terá como saída:</p>
<pre><code>+--------------------------------------+---------------+--------------------+----------------------+
| id           | stack_name    | stack_status       | creation_time        |
+--------------------------------------+---------------+--------------------+----------------------+
| 4c712026-dcd5-4664-90b8-0915494c1332 | mystack       | CREATE_IN_PROGRESS | 2013-04-03T23:22:08Z |
+--------------------------------------+---------------+--------------------+----------------------+</code></pre>
<p>Você também pode usar o comando <em>stack-create</em> para validar um template sem criar um stack:</p>
<pre><code>heat stack-create mystack --template-file=/PATH_TO_HEAT_TEMPLATES/WordPress_Single_Instance.template</code></pre>
<p>Se a validação falhar, a resposta irá retornar uma mensagem de erro.</p>
<h3 id="obtenha-informações-dos-stacks">5.2.2 Obtenha informações dos stacks</h3>
<p>Explore o estado e historico de uma stack específica, com os comandos abaixo.</p>
<ul>
<li>Listar os stacks atuais</li>
</ul>
<pre><code>$ heat stack-list
+--------------------------------------+---------------+-----------------+----------------------+
| id           | stack_name    | stack_status    | creation_time        |
+--------------------------------------+---------------+-----------------+----------------------+
| 4c712026-dcd5-4664-90b8-0915494c1332 | mystack       | CREATE_COMPLETE | 2013-04-03T23:22:08Z |
| 7edc7480-bda5-4e1c-9d5d-f567d3b6a050 | my-otherstack | CREATE_FAILED   | 2013-04-03T23:28:20Z |
+--------------------------------------+---------------+-----------------+----------------------+</code></pre>
<ul>
<li>Mostrar os detalhes de um stack</li>
</ul>
<pre><code>$ heat resource-list mystack
+---------------------+--------------------+-----------------+----------------------+
| logical_resource_id | resource_type      | resource_status | updated_time         |
+---------------------+--------------------+-----------------+----------------------+
| WikiDatabase        | AWS::EC2::Instance | CREATE_COMPLETE | 2013-04-03T23:25:56Z |
+---------------------+--------------------+-----------------+----------------------+</code></pre>
<ul>
<li>Um stack consiste em uma coleção de recursos, liste seus recursos</li>
</ul>
<pre><code>$ heat resource-show mystack WikiDatabase
</code></pre>
<ul>
<li>Uma série de eventos é gerado durante o ciclo de vida de um stack, mostre seu ciclo de vida</li>
</ul>
<pre><code>$ heat event-list mystack
+---------------------+----+------------------------+-----------------+----------------------+
| logical_resource_id | id | resource_status_reason | resource_status | event_time           |
+---------------------+----+------------------------+-----------------+----------------------+
| WikiDatabase        | 1  | state changed          | IN_PROGRESS     | 2013-04-03T23:22:09Z |
| WikiDatabase        | 2  | state changed          | CREATE_COMPLETE | 2013-04-03T23:25:56Z |
+---------------------+----+------------------------+-----------------+----------------------+</code></pre>
<ul>
<li>Veja detalhes de um evento particular</li>
</ul>
<pre><code>$ heat event-show WikiDatabase 1</code></pre>
<ul>
<li>Atualize o template de um stack</li>
</ul>
<pre><code>$ heat stack-update mystack --template-file=/path/to/heat/templates/WordPress_Single_Instance_v2.template
     --parameters=&quot;InstanceType=m1.large;DBUsername=wp;DBPassword=verybadpassword;KeyName=heat_key;LinuxDistribution=F17&quot;
     +--------------------------------------+---------------+-----------------+----------------------+
     | id           | stack_name    | stack_status    | creation_time        |
     +--------------------------------------+---------------+-----------------+----------------------+
     | 4c712026-dcd5-4664-90b8-0915494c1332 | mystack       | UPDATE_COMPLETE | 2013-04-03T23:22:08Z |
     | 7edc7480-bda5-4e1c-9d5d-f567d3b6a050 | my-otherstack | CREATE_FAILED   | 2013-04-03T23:28:20Z |
     +--------------------------------------+---------------+-----------------+----------------------+</code></pre>
<h2 id="adicionando-o-dashboard-horizon">6. Adicionando o Dashboard (Horizon)</h2>
<ul>
<li>Não houve nenhum problema encontrado na instalação deste serviço.</li>
</ul>
<p>Instale os seguintes pacotes no controller node.</p>
<pre><code># apt-get install memcached libapache2-mod-wsgi openstack-dashboard</code></pre>
<p>Abra o /etc/openstack-dashboard/local_settings.py e procure por essa linha:</p>
<pre><code>CACHES = {
&#39;default&#39;: {
&#39;BACKEND&#39; : &#39;django.core.cache.backends.memcached.MemcachedCache&#39;,
&#39;LOCATION&#39; : &#39;127.0.0.1:11211&#39;
}
}</code></pre>
<p>O endereço e a porta devem ser o mesmo que definido pelo arquivo /etc/memcached.conf</p>
<p>Atualize o ALLOWED_HOSTS em local_settings.py para incluir os endereços que você deseja que acessem o dashboard: ALLOWED_HOSTS = ['localhost', 'my-desktop']</p>
<p>Edite também o OPENSTACK_HOST para controller:</p>
<pre><code>OPENSTACK_HOST = &quot;controller&quot;</code></pre>
<p>Reinicie o Apache Web e memcached.</p>
<pre><code># service apache2 restart
# service memcached restart</code></pre>
<p>Agora você pode acessar o dashboard a partir do endereço https://controller/</p>
<h3 id="links-importantes-para-troubleshooting">7. Links importantes para Troubleshooting</h3>
<ul>
<li>http://virtual2privatecloud.com/troubleshooting-openstack-nova/</li>
<li>http://wiki.libvirt.org/page/VM_lifecycle</li>
<li>https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Virtualization_Host_Configuration_and_Guest_Installation_Guide/apb.html</li>
<li>https://ask.openstack.org/en/question/12623/i-cannot-create-vms-libvirt-error/</li>
<li>https://ask.openstack.org/en/question/8581/no-connection-to-metadata-service-nova-network/?answer=8611#post-id-8611</li>
<li>https://ask.openstack.org/en/question/5142/nova-network-create-fails-with-401-unauthorized/</li>
<li>https://ask.openstack.org/en/question/3542/error-installing-nova-compute/</li>
</ul>
<h2 id="referência">8. Referência</h2>
<ul>
<li>http://docs.openstack.org/havana/install-guide/install/apt/content/</li>
<li>http://docs.openstack.org/user-guide/content/</li>
</ul>
</body>
</html>
